{% extends "base.html.j2" %}
{% block content %}
{% from "macros/user_macros.html.j2" import user_display %}

<div class="align-center text-center">
  <img src="{{ url_for('static', filename='icon.png') }}" alt="Logo" style="height: 64px;" class="mb-4">
</div>

{# input edit for user #}
{% if session.get('user_id') %}
<div class="col-md-8 mx-auto mb-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Create a new post</h5>
      <form action="{{ url_for('add_post') }}" method="POST">
        <div class="mb-3">
          <textarea class="form-control" name="content" rows="3"
            placeholder="What's on your mind, {{ session.get('username') }}?" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary float-end">Post</button>
      </form>
    </div>
  </div>
</div>
{% endif %}

<h2 class="text-center border-bottom pb-2 mb-4"><span>Posts</span></h2>

<div class="mb-4 text-center">

  <!-- This is the 'sort' filter for New / Popular / Recommended -->
  <div class="btn-group me-5" role="group" aria-label="Sort posts">
    <!-- The link preserves the current_show state -->
    <a href="{{ url_for('feed', sort='new', show=current_show) }}"
      class="btn {% if current_sort == 'new' %}btn-primary{% else %}btn-light{% endif %}">New</a>
    <a href="{{ url_for('feed', sort='popular', show=current_show) }}"
      class="btn {% if current_sort == 'popular' %}btn-primary{% else %}btn-light{% endif %}">Popular</a>
    <a href="{{ url_for('feed', sort='recommended', show=current_show) }}"
      class="btn {% if current_sort == 'recommended' %}btn-primary{% else %}btn-light{% endif %}">Recommended</a>
  </div>

  <!-- This is the 'show' filter for All / Following -->
  <!-- Following is only shown to logged in users -->
  {% if session.get('user_id') %}
  <div class="btn-group" role="group" aria-label="Filter posts">
    <!-- The link preserves the current_sort state -->
    <a href="{{ url_for('feed', sort=current_sort, show='all') }}"
      class="btn {% if current_show == 'all' %}btn-primary{% else %}btn-light{% endif %}">All</a>
    <a href="{{ url_for('feed', sort=current_sort, show='following') }}"
      class="btn {% if current_show == 'following' %}btn-primary{% else %}btn-light{% endif %}">Following</a>
  </div>
  {% endif %}


</div>

<div class="col-md-8 mx-auto">
  {% for entry in posts %}
  <div class="card mb-4" id="post-{{ entry.post.id }}">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">
          {% if entry.followed_poster %}
          <a href="/u/{{ entry.post.user_id }}">{{ user_display(entry.post.username) }}<span class="text-success p-1"
              data-toggle="tooltip" data-placement="top" title="You are following this user"> ‚úì </span>
          </a>
          {% else %}
          <a href="/u/{{ entry.post.user_id }}">{{ user_display(entry.post.username) }} </a>
          {% endif %}
        </h3>


        {% if session.get('user_id') == entry.post.user_id %}
        <div class="d-flex align-items-center">
          <small class="text-muted me-3">{{ entry.post.created_at|datetimeformat }}</small>
          <form action="{{ url_for('delete_post', post_id=entry.post.id) }}" method="POST"
            onsubmit="return confirm('Are you sure you want to delete this post?');">
            <button type="submit" class="btn btn-danger" title="Delete Post">
              delete
            </button>
          </form>
        </div>
        {% else %}
        <small class="text-muted">{{ entry.post.created_at|datetimeformat }}</small>
        {% endif %}
      </div>

      <p class="mt-2">{{ entry.post.content }}</p>

      <!-- Reactions Display and Add Reaction Button -->
      <div class="d-flex align-items-center mt-2 mb-2">
        <!-- Display existing reactions -->
        <div class="reactions-display me-2">
          {% if entry.reactions %}
          {% for react in entry.reactions %}
          {% if react.reaction_type == entry.user_reaction %}
          <form action="{{ url_for('unreact') }}" method="post" class="d-inline">
            <input type="hidden" name="post_id" value="{{ entry.post.id }}">
            <button type="submit" class="btn btn-light text-dark me-1" title="{{ react.reaction_type|capitalize }}">
              {{ reaction_emojis.get(react.reaction_type, 'üëç') }} {{ react.count }}
            </button>
          </form>
          {% else %}
          <span class=" text-dark me-1" title="{{ react.reaction_type|capitalize }}">
            {{ reaction_emojis.get(react.reaction_type, 'üëç') }} {{ react.count }}
          </span>
          {% endif %}
          {% endfor %}
          {% else %}
          <span class="text-muted"> No reactions yet </span>
          {% endif %}
        </div>

        <!-- Add Reaction Dropdown Button -->
        {% if session.get('user_id') %}
        <div class="dropdown">
          <button class="btn btn-sm btn-light text-dark rounded-circle m-0" type="button"
            id="dropdownMenuButton-{{ entry.post.id }}" data-bs-toggle="dropdown" aria-expanded="false"
            title="Add Reaction">
            +
          </button>
          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton-{{ entry.post.id }}">
            {% for reaction_type in reaction_types %}
            <li>
              <form action="{{ url_for('add_reaction') }}" method="POST" class="d-inline">
                <input type="hidden" name="post_id" value="{{ entry.post.id }}">
                <input type="hidden" name="reaction" value="{{ reaction_type }}">
                <button type="submit" class="dropdown-item">
                  {{ reaction_emojis.get(reaction_type, 'üëç') }} {{ reaction_type|capitalize }}
                </button>
              </form>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {# add this button at the right side of this section #}
        <button class="btn btn-primary btn-sm ms-auto" data-bs-toggle="modal"
          data-bs-target="#addRepostModal-{{ entry.post.id }}">
          Repost
        </button>
      </div>


      {% if entry.comments %}
      <hr>
      {% if entry.comments %}
      <h6 class="mb-0">Comments ({{ entry.comments | count }})</h4>
        {% else %}
        <h6 class="mb-0">Comments</h4>
          {% endif %}
          <ul class="list-group list-group-flush shadow-none border-0">
            {% for comment in entry.comments[-2:] %}
            <li class="card shadow-none p-2 mt-2">
              <div class="d-flex justify-content-between">
                <div>
                  <strong><a href="/u/{{ comment.username }}">{{ user_display(comment.username) }}</a></strong>
                  <p class="mb-0">{{ comment.content }}</p>
                </div>

                {% if session.get('user_id') == comment.user_id or session.get('user_id') == entry.post.user_id %}
                <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST"
                  onsubmit="return confirm('Are you sure you want to delete this comment?');">
                  <button type="submit" class="btn btn-sm btn-danger" title="Delete Comment">delete</button>
                </form>
                {% endif %}

              </div>
            </li>
            {% endfor %}
          </ul>
          {% endif %}

          <div class="d-flex justify-content-between mt-3">
            <a href="/posts/{{ entry.post.id }}" class="btn btn-sm btn-light show-comments-btn">
              Show all comments
            </a>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
              data-bs-target="#addCommentModal-{{ entry.post.id }}">Add Comment</button>
          </div>
    </div>
  </div>


  <div class="modal fade" id="addCommentModal-{{ entry.post.id }}" tabindex="-1"
    aria-labelledby="addCommentModalLabel-{{ entry.post.id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCommentModalLabel-{{ entry.post.id }}">Add a comment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="/posts/{{ entry.post.id }}/comment" method="POST">
            <div class="mb-3">
              <label for="comment-content-{{ entry.post.id }}" class="form-label">Your Comment</label>
              <textarea class="form-control" id="comment-content-{{ entry.post.id }}" name="content" rows="3"
                required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Comment</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addRepostModal-{{ entry.post.id }}" tabindex="-1"
    aria-labelledby="addRepostModalLabel-{{ entry.post.id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addRepostModalLabel-{{ entry.post.id }}">Repost</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="/posts/{{ entry.post.id }}/repost" method="POST">
            <div class="mb-3">
              <label for="repost-content-{{ entry.post.id }}" class="form-label">Add a repost comment or not</label>
              <textarea class="form-control" id="repost-content-{{ entry.post.id }}" name="content" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Repost</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <p class="text-center">No posts to display.</p>
  {% endfor %}
</div>

<div class="d-flex justify-content-center align-items-center my-4">
  <a href="{{ url_for('feed', page=page-1, sort=current_sort, show=current_show) }}"
    class="btn btn-primary {% if page <= 1 %}btn-light disabled{% endif %}">
    &laquo; Previous
  </a>
  <span class="mx-3 text-muted">Page {{ page }}</span>
  <a href="{{ url_for('feed', page=page+1, sort=current_sort, show=current_show) }}"
    class="btn btn-primary {% if posts|length < per_page %}disabled{% endif %}">
    Next &raquo;
  </a>
</div>
{% endblock %}